#!/usr/bin/env bash
set -euo pipefail

mkdir -p /var/log/cmux

color=""
case "${VSCODE_THEME:-}" in
  dark)
    color="Default Dark Modern"
    ;;
  light)
    color="Default Light Modern"
    ;;
  system)
    color="Default Dark Modern"
    ;;
esac

home="${HOME:-/root}"
user_base="${home}/.openvscode-server"
user_dir="${user_base}/data/User"
default_profile_dir="${user_base}/data/User/profiles/default-profile"
machine_dir="${user_base}/data/Machine"
source_dir="/root/lifecycle/vscode-user-data"

mkdir -p "${user_dir}" "${default_profile_dir}" "${machine_dir}"

synced_settings=false

if [ -d "${source_dir}" ]; then
  if [ -f "${source_dir}/settings.json" ]; then
    cp -f "${source_dir}/settings.json" "${user_dir}/settings.json"
    cp -f "${source_dir}/settings.json" "${default_profile_dir}/settings.json"
    cp -f "${source_dir}/settings.json" "${machine_dir}/settings.json"
    synced_settings=true
  fi

  if [ -f "${source_dir}/keybindings.json" ]; then
    cp -f "${source_dir}/keybindings.json" "${user_dir}/keybindings.json"
  fi

  if [ -f "${source_dir}/locale.json" ]; then
    cp -f "${source_dir}/locale.json" "${user_dir}/locale.json"
  fi

  if [ -d "${source_dir}/snippets" ]; then
    rm -rf "${user_dir}/snippets"
    cp -r "${source_dir}/snippets" "${user_dir}/snippets"
  fi
fi

if ! $synced_settings; then
  SETTINGS=$(jq -n \
    --arg theme "$color" \
    '{
      "workbench.startupEditor": "none",
      "terminal.integrated.shellIntegration.enabled": false,
      "terminal.integrated.macOptionClickForcesSelection": true,
      "terminal.integrated.shell.linux": "/usr/bin/zsh",
      "terminal.integrated.shellArgs.linux": ["-l"],
      "terminal.integrated.defaultProfile.linux": "zsh",
      "terminal.integrated.profiles.linux": {
        "zsh": {
          "path": "/usr/bin/zsh",
          "args": ["-l"]
        }
      },
      "python.languageServer": "Pylance",
      "python.defaultInterpreterPath": "/usr/bin/python3",
      "git.openDiffOnClick": true,
      "scm.defaultViewMode": "tree",
      "git.showPushSuccessNotification": true,
      "git.autorefresh": true,
      "git.branchCompareWith": "main"
    } + (if $theme != "" then {"workbench.colorTheme": $theme} else {} end)')

  printf '%s' "$SETTINGS" > "${user_dir}/settings.json"
  printf '%s' "$SETTINGS" > "${default_profile_dir}/settings.json"
  printf '%s' "$SETTINGS" > "${machine_dir}/settings.json"
fi
