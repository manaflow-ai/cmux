name: CI

on:
  push:
    branches:
      - main
  pull_request:

jobs:
  web-typecheck:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: web
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Typecheck
        run: bun tsc --noEmit

  macos-tests:
    runs-on: self-hosted
    concurrency:
      group: self-hosted-build
      cancel-in-progress: false
    timeout-minutes: 360
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Select Xcode
        run: |
          set -euo pipefail
          if [ -d "/Applications/Xcode.app/Contents/Developer" ]; then
            XCODE_DIR="/Applications/Xcode.app/Contents/Developer"
          else
            XCODE_APP="$(ls -d /Applications/Xcode*.app 2>/dev/null | head -n 1 || true)"
            if [ -n "$XCODE_APP" ]; then
              XCODE_DIR="$XCODE_APP/Contents/Developer"
            else
              echo "No Xcode.app found under /Applications" >&2
              exit 1
            fi
          fi
          echo "DEVELOPER_DIR=$XCODE_DIR" >> "$GITHUB_ENV"
          export DEVELOPER_DIR="$XCODE_DIR"
          xcodebuild -version
          xcrun --sdk macosx --show-sdk-path

      - name: Download Metal Toolchain
        run: xcodebuild -downloadComponent MetalToolchain

      - name: Build GhosttyKit.xcframework
        run: |
          set -euo pipefail
          if ! command -v zig >/dev/null 2>&1; then
            if command -v brew >/dev/null 2>&1; then
              brew install zig
            else
              echo "zig is required to build GhosttyKit.xcframework. Install zig and retry." >&2
              exit 1
            fi
          fi
          (cd ghostty && zig build -Demit-xcframework=true -Demit-macos-app=false -Doptimize=ReleaseFast)
          rm -rf GhosttyKit.xcframework
          cp -R ghostty/macos/GhosttyKit.xcframework GhosttyKit.xcframework
          test -d GhosttyKit.xcframework

      - name: Clean DerivedData
        run: |
          # Remove stale build cache to avoid incremental build errors
          rm -rf ~/Library/Developer/Xcode/DerivedData/cmux-*
          rm -rf ~/Library/Developer/Xcode/DerivedData/cmux-tests-v1
          rm -rf ~/Library/Developer/Xcode/DerivedData/cmux-tests-v2

      - name: Run Unit Tests
        run: |
          set -euo pipefail
          ./scripts/test-unit.sh test

      - name: Run UI Tests
        run: |
          set -euo pipefail
          xcodebuild -project cmux.xcodeproj -scheme cmux -configuration Debug -destination "platform=macOS" -only-testing:cmuxUITests test

      - name: Run Python E2E Tests (v1)
        env:
          CMUX_TEST_ALLOW_ANY_USER: "1"
        run: |
          set -euo pipefail
          ./scripts/run-tests-v1.sh

      - name: Run Python E2E Tests (v2)
        env:
          CMUX_TEST_ALLOW_ANY_USER: "1"
        run: |
          set -euo pipefail
          ./scripts/run-tests-v2.sh

      - name: Run Interactive Test Entry Points (expect skip in CI)
        run: |
          set -euo pipefail
          python3 tests/test_ctrl_interactive.py
          python3 tests_v2/test_ctrl_interactive.py
          bash tests/test_ctrl_signals.sh
          bash tests/test_app_keystrokes.sh
